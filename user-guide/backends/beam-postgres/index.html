
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.2, mkdocs-material-1.6.1">
    
    
      
        <title>beam-postgres - Beam Documentation</title>
      
    
    
      <script src="../../../assets/javascripts/modernizr-56ade86843.js"></script>
    
    

      <link rel="stylesheet" href="../../../assets/stylesheets/application-4d0d3f2fbf.css">
      
    
<link rel="stylesheet" type="text/css" href="/css/beam.css"/>

    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../../theme/css/beam.css">
    
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="../../.." title="Beam Documentation" class="md-logo md-header-nav__button">
            <img src="../../../img/logo.svg" width="24" height="24">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  Backends
                </span>
              
            
            beam-postgres
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">close</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <div class="md-header-nav__source">
          
            


  


  <a href="https://github.com/tathougies/beam" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      tathougies/beam
    </div>
  </a>

          
        </div>
      </div>
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-logo md-nav__button">
        <img src="../../../img/logo.svg">
      </i>
    
    Beam Documentation
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/tathougies/beam" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      tathougies/beam
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../about/faq/" title="Frequently Asked Questions" class="md-nav__link">
      Frequently Asked Questions
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Tutorial
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Tutorial
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../tutorials/tutorial1/" title="Part 1" class="md-nav__link">
      Part 1
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../tutorials/tutorial2/" title="Part 2" class="md-nav__link">
      Part 2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../tutorials/tutorial3/" title="Part 3" class="md-nav__link">
      Part 3
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      User Guide
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        User Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../models/" title="Models" class="md-nav__link">
      Models
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../databases/" title="Databases" class="md-nav__link">
      Databases
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Backends" class="md-nav__link">
      Backends
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../expressions/" title="Expressions" class="md-nav__link">
      Expressions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-5" type="checkbox" id="nav-4-5">
    
    <label class="md-nav__link" for="nav-4-5">
      Queries
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-5">
        Queries
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../queries/basic/" title="Basic Queries" class="md-nav__link">
      Basic Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../queries/select/" title="More complex SELECTs" class="md-nav__link">
      More complex SELECTs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../queries/ordering/" title="Ordering" class="md-nav__link">
      Ordering
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../queries/relationships/" title="Relationships" class="md-nav__link">
      Relationships
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../queries/aggregates/" title="Aggregates" class="md-nav__link">
      Aggregates
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../queries/combining-queries/" title="Combining queries" class="md-nav__link">
      Combining queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../queries/window-functions/" title="Window functions" class="md-nav__link">
      Window functions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../queries/advanced-features/" title="Advanced features" class="md-nav__link">
      Advanced features
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../extensibility/" title="Custom queries" class="md-nav__link">
      Custom queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-7" type="checkbox" id="nav-4-7">
    
    <label class="md-nav__link" for="nav-4-7">
      Data Manipulation
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-7">
        Data Manipulation
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../manipulation/insert/" title="INSERT" class="md-nav__link">
      INSERT
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../manipulation/update/" title="UPDATE" class="md-nav__link">
      UPDATE
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../manipulation/delete/" title="DELETE" class="md-nav__link">
      DELETE
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Schema management
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Schema management
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../schema-guide/migrations/" title="The Migrations Framework" class="md-nav__link">
      The Migrations Framework
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../schema-guide/tool/" title="The beam-migrate tool" class="md-nav__link">
      The beam-migrate tool
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../schema-guide/supported/" title="Supported migrations" class="md-nav__link">
      Supported migrations
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked>
    
    <label class="md-nav__link" for="nav-6">
      Backends
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Backends
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        beam-postgres
      </label>
    
    <a href="./" title="beam-postgres" class="md-nav__link md-nav__link--active">
      beam-postgres
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#postgres-specific-data-types" title="Postgres-specific data types" class="md-nav__link">
    Postgres-specific data types
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-tsvector-and-tsquery-types" title="The tsvector and tsquery types" class="md-nav__link">
    The tsvector and tsquery types
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#postgres-extensions" title="Postgres extensions" class="md-nav__link">
    Postgres extensions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#select-locking-clause" title="SELECT locking clause" class="md-nav__link">
    SELECT locking clause
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#distinct-on-support" title="DISTINCT ON support" class="md-nav__link">
    DISTINCT ON support
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregates" title="Aggregates" class="md-nav__link">
    Aggregates
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#string_agg" title="string_agg" class="md-nav__link">
    string_agg
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on-conflict" title="ON CONFLICT" class="md-nav__link">
    ON CONFLICT
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#acting-on-any-conflict" title="Acting on any conflict" class="md-nav__link">
    Acting on any conflict
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acting-only-on-certain-conflicts" title="Acting only on certain conflicts" class="md-nav__link">
    Acting only on certain conflicts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#specifying-actions" title="Specifying actions" class="md-nav__link">
    Specifying actions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../beam-sqlite/" title="beam-sqlite" class="md-nav__link">
      beam-sqlite
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../custom-backends/" title="Writing a Custom Backend" class="md-nav__link">
      Writing a Custom Backend
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      About
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        About
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../about/compatibility/" title="Compatibility Matrix" class="md-nav__link">
      Compatibility Matrix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../about/license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../about/release-notes/" title="Release Notes" class="md-nav__link">
      Release Notes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#postgres-specific-data-types" title="Postgres-specific data types" class="md-nav__link">
    Postgres-specific data types
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-tsvector-and-tsquery-types" title="The tsvector and tsquery types" class="md-nav__link">
    The tsvector and tsquery types
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#postgres-extensions" title="Postgres extensions" class="md-nav__link">
    Postgres extensions
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#select-locking-clause" title="SELECT locking clause" class="md-nav__link">
    SELECT locking clause
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#distinct-on-support" title="DISTINCT ON support" class="md-nav__link">
    DISTINCT ON support
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregates" title="Aggregates" class="md-nav__link">
    Aggregates
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#string_agg" title="string_agg" class="md-nav__link">
    string_agg
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on-conflict" title="ON CONFLICT" class="md-nav__link">
    ON CONFLICT
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#acting-on-any-conflict" title="Acting on any conflict" class="md-nav__link">
    Acting on any conflict
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#acting-only-on-certain-conflicts" title="Acting only on certain conflicts" class="md-nav__link">
    Acting only on certain conflicts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#specifying-actions" title="Specifying actions" class="md-nav__link">
    Specifying actions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>beam-postgres</h1>
                
                <p>The <code>beam-postgres</code> backend is the most feature complete SQL backend for beam.
The Postgres RDBMS supports most of the standards beam follows, so you can
usually expect most queries to simply work. Additionally, <code>beam-postgres</code> is
part of the standard Beam distribution, and so upgrades are applied
periodically, and new functions are added to achieve feature-parity with the
latest Postgres stable</p>
<h2 id="postgres-specific-data-types">Postgres-specific data types</h2>
<p>Postgres has several data types not available from <code>beam-core</code>. The
<code>beam-postgres</code> library provides several types and functions to make working
with these easier.</p>
<h3 id="the-tsvector-and-tsquery-types">The <code>tsvector</code> and <code>tsquery</code> types</h3>
<p>The <code>tsvector</code> and <code>tsquery</code> types form the basis of full-text search in
Postgres.</p>
<h2 id="postgres-extensions">Postgres extensions</h2>
<h3 id="select-locking-clause"><code>SELECT</code> locking clause</h3>
<p>Postgres allows you to explicitly lock rows retrieved during a select
using the <a href="https://www.postgresql.org/docs/current/static/explicit-locking.html">locking
clause</a>.</p>
<p>Beam supports most of the Postgres locking clause. However, there are some
invariants that are currently not checked at compile time. For example, Postgres
does not allow locking clauses with queries that use <code>UNION</code>, <code>EXCEPT</code>, or
<code>INTERSECT</code> or those with aggregates. Since all these queries have the same type
in Beam, we cannot catch these errors at compile-time. Current guidance is to
only use the locking clause in top-level queries that you know to be
safe.</p>
<p>The following example finds all customers living in Dublin, and requests a <code>ROW
SHARE</code> lock for each row. This prevents concurrent updates from updating these
rows until the current transaction is complete.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-0-Haskell" aria-controls="tab-0-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-0-Postgres" aria-controls="tab-0-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-0-Haskell">
            <div class="codehilite"><pre><span></span><span class="kt">Pg</span><span class="o">.</span><span class="n">lockingAllTablesFor_</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingStrengthShare</span> <span class="kt">Nothing</span> <span class="o">$</span>
  <span class="n">filter_</span> <span class="p">(</span><span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> <span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">c</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;Dublin&quot;</span><span class="p">)</span> <span class="o">$</span>
  <span class="n">all_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-0-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;CustomerId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Company&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res3&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Address&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res4&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res5&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;State&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res6&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Country&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res7&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res8&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Phone&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res9&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Fax&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res10&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Email&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res11&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;SupportRepId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res12&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="n">COALESCE</span><span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Dublin&#39;</span><span class="p">)</span>
  <span class="k">FOR</span> <span class="k">SHARE</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>Now, suppose we want to update these rows, so we'll want to lock them for an update.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-1-Haskell" aria-controls="tab-1-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-1-Postgres" aria-controls="tab-1-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-1-Haskell">
            <div class="codehilite"><pre><span></span><span class="kt">Pg</span><span class="o">.</span><span class="n">lockingAllTablesFor_</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingStrengthUpdate</span> <span class="kt">Nothing</span> <span class="o">$</span>
  <span class="n">filter_</span> <span class="p">(</span><span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> <span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">c</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;Dublin&quot;</span><span class="p">)</span> <span class="o">$</span>
  <span class="n">all_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-1-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;CustomerId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Company&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res3&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Address&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res4&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res5&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;State&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res6&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Country&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res7&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res8&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Phone&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res9&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Fax&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res10&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Email&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res11&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;SupportRepId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res12&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="n">COALESCE</span><span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Dublin&#39;</span><span class="p">)</span>
  <span class="k">FOR</span>
  <span class="k">UPDATE</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>However, because there may be a lot of customers in Dublin that we'd like to
update, this may block for a long time. Perhaps, we'd only like to lock rows
that aren't already locked. This is inconsistent in general, but we do not
always care.  Postgres offers the <code>SKIP LOCKED</code> clause for this</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-2-Haskell" aria-controls="tab-2-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-2-Postgres" aria-controls="tab-2-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-2-Haskell">
            <div class="codehilite"><pre><span></span><span class="kt">Pg</span><span class="o">.</span><span class="n">lockingAllTablesFor_</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingStrengthUpdate</span> <span class="p">(</span><span class="kt">Just</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingOptionsSkipLocked</span><span class="p">)</span> <span class="o">$</span>
  <span class="n">filter_</span> <span class="p">(</span><span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> <span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">c</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;Dublin&quot;</span><span class="p">)</span> <span class="o">$</span>
  <span class="n">all_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-2-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;CustomerId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Company&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res3&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Address&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res4&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res5&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;State&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res6&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Country&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res7&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res8&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Phone&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res9&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Fax&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res10&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Email&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res11&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;SupportRepId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res12&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="n">COALESCE</span><span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Dublin&#39;</span><span class="p">)</span>
  <span class="k">FOR</span>
  <span class="k">UPDATE</span> <span class="n">SKIP</span> <span class="n">LOCKED</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>Or, if we do care, and don't want to wait anyway, we can ask Postgres to fail
early instead of blocking, using <code>NO WAIT</code></p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-3-Haskell" aria-controls="tab-3-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-3-Postgres" aria-controls="tab-3-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-3-Haskell">
            <div class="codehilite"><pre><span></span><span class="kt">Pg</span><span class="o">.</span><span class="n">lockingAllTablesFor_</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingStrengthUpdate</span> <span class="p">(</span><span class="kt">Just</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingOptionsNoWait</span><span class="p">)</span> <span class="o">$</span>
  <span class="n">filter_</span> <span class="p">(</span><span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> <span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">c</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;Dublin&quot;</span><span class="p">)</span> <span class="o">$</span>
  <span class="n">all_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-3-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;CustomerId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Company&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res3&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Address&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res4&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res5&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;State&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res6&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Country&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res7&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res8&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Phone&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res9&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Fax&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res10&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Email&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res11&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;SupportRepId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res12&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="n">COALESCE</span><span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Dublin&#39;</span><span class="p">)</span>
  <span class="k">FOR</span>
  <span class="k">UPDATE</span> <span class="n">NOWAIT</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>We can also specify the locking clauses when <code>JOIN</code>ing. Suppose we want to get
all customers who live in London <em>and</em> have a support rep who lives in Paris,
and skipping rows that we can't lock.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-4-Haskell" aria-controls="tab-4-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-4-Postgres" aria-controls="tab-4-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-4-Haskell">
            <div class="codehilite"><pre><span></span><span class="kt">Pg</span><span class="o">.</span><span class="n">lockingAllTablesFor_</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingStrengthShare</span> <span class="p">(</span><span class="kt">Just</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingOptionsSkipLocked</span><span class="p">)</span> <span class="o">$</span>
  <span class="kr">do</span> <span class="n">customer</span> <span class="ow">&lt;-</span> <span class="n">filter_</span> <span class="p">(</span><span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> <span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">c</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;London&quot;</span><span class="p">)</span> <span class="o">$</span>
                 <span class="n">all_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
     <span class="n">employee</span> <span class="ow">&lt;-</span> <span class="n">join_</span> <span class="p">(</span><span class="n">employee</span> <span class="n">chinookDb</span><span class="p">)</span>
                       <span class="p">(</span><span class="nf">\</span><span class="n">e</span> <span class="ow">-&gt;</span> <span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">employeeAddress</span> <span class="n">e</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;Paris&quot;</span> <span class="o">&amp;&amp;.</span>
                              <span class="n">just_</span> <span class="p">(</span><span class="n">pk</span> <span class="n">e</span><span class="p">)</span> <span class="o">==.</span> <span class="n">customerSupportRep</span> <span class="n">customer</span><span class="p">)</span>
     <span class="n">pure</span> <span class="p">(</span><span class="n">customerFirstName</span> <span class="n">customer</span><span class="p">,</span> <span class="n">customerLastName</span> <span class="n">customer</span><span class="p">,</span> <span class="n">pk</span> <span class="n">employee</span><span class="p">)</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-4-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;EmployeeId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">INNER</span> <span class="k">JOIN</span> <span class="ss">&quot;Employee&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t1&quot;</span> <span class="k">ON</span> <span class="p">((</span><span class="n">COALESCE</span><span class="p">(</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Paris&#39;</span><span class="p">))</span>
<span class="k">AND</span> <span class="p">((</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;EmployeeId&quot;</span><span class="p">)</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">DISTINCT</span>
     <span class="k">FROM</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;SupportRepId&quot;</span><span class="p">))</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="n">COALESCE</span><span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;London&#39;</span><span class="p">)</span>
  <span class="k">FOR</span> <span class="k">SHARE</span> <span class="n">SKIP</span> <span class="n">LOCKED</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>You may notice that this query will lock rows in both the customers and
employees table. This may not be what you want. You can also specify which
tables to lock by using the <code>lockingFor_</code> function. This requires you to specify
which locks you want to hold by returning them from your query. For example, to
lock only the customers table</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-5-Haskell" aria-controls="tab-5-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-5-Postgres" aria-controls="tab-5-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-5-Haskell">
            <div class="codehilite"><pre><span></span><span class="kt">Pg</span><span class="o">.</span><span class="n">lockingFor_</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingStrengthShare</span> <span class="p">(</span><span class="kt">Just</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingOptionsSkipLocked</span><span class="p">)</span> <span class="o">$</span>
  <span class="kr">do</span> <span class="p">(</span><span class="n">customerLock</span><span class="p">,</span> <span class="n">customer</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="kt">Pg</span><span class="o">.</span><span class="n">locked_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
     <span class="n">guard_</span> <span class="p">(</span><span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">customer</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;London&quot;</span><span class="p">)</span>
     <span class="n">employee</span> <span class="ow">&lt;-</span> <span class="n">filter_</span> <span class="p">(</span><span class="nf">\</span><span class="n">e</span> <span class="ow">-&gt;</span> <span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">employeeAddress</span> <span class="n">e</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;Paris&quot;</span> <span class="o">&amp;&amp;.</span>
                                <span class="n">just_</span> <span class="p">(</span><span class="n">pk</span> <span class="n">e</span><span class="p">)</span> <span class="o">==.</span> <span class="n">customerSupportRep</span> <span class="n">customer</span><span class="p">)</span> <span class="o">$</span>
                 <span class="n">all_</span> <span class="p">(</span><span class="n">employee</span> <span class="n">chinookDb</span><span class="p">)</span>
     <span class="n">pure</span> <span class="p">((</span><span class="n">customerFirstName</span> <span class="n">customer</span><span class="p">,</span> <span class="n">customerLastName</span> <span class="n">customer</span><span class="p">,</span> <span class="n">pk</span> <span class="n">employee</span><span class="p">)</span> <span class="p">`</span><span class="kt">Pg</span><span class="o">.</span><span class="n">withLocks_</span><span class="p">`</span> <span class="n">customerLock</span><span class="p">)</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-5-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;EmployeeId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="ss">&quot;Employee&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t1&quot;</span>
<span class="k">WHERE</span> <span class="p">((</span><span class="n">COALESCE</span><span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;London&#39;</span><span class="p">))</span>
  <span class="k">AND</span> <span class="p">(((</span><span class="n">COALESCE</span><span class="p">(</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Paris&#39;</span><span class="p">))</span>
       <span class="k">AND</span> <span class="p">((</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;EmployeeId&quot;</span><span class="p">)</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">DISTINCT</span>
            <span class="k">FROM</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;SupportRepId&quot;</span><span class="p">)))</span>
  <span class="k">FOR</span> <span class="k">SHARE</span> <span class="k">OF</span> <span class="ss">&quot;t0&quot;</span> <span class="n">SKIP</span> <span class="n">LOCKED</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>In order to use the explicit locking clause, you need to use the <code>locked_</code>
function to get a reference to a lock for a particular table. This forces the
locked table to be part of the join, which is a requirement for the Postgres
locking clause. You can think of <code>locked_</code> as exactly like <code>all_</code>, except it
returns a table lock as the first return value.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Locks can be combined monoidally, using <code>mappend</code> or <code>(&lt;&gt;)</code>. You can use this
to lock multiple tables, by passing the result of <code>mappend</code> to <code>withLocks_</code>.</p>
<p>If you return <code>mempty</code> as the first argument, then this recovers the standard
behavior of locking all tables.</p>
</div>
<p><code>lockingFor_</code> is the most general locking combinator. You can recover the same
behavior as <code>lockingAllTablesFor_</code> by using the <code>lockAll_</code> function.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-6-Haskell" aria-controls="tab-6-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-6-Postgres" aria-controls="tab-6-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-6-Haskell">
            <div class="codehilite"><pre><span></span><span class="kt">Pg</span><span class="o">.</span><span class="n">lockingFor_</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingStrengthShare</span> <span class="p">(</span><span class="kt">Just</span> <span class="kt">Pg</span><span class="o">.</span><span class="kt">PgSelectLockingOptionsSkipLocked</span><span class="p">)</span> <span class="o">$</span>
  <span class="kr">do</span> <span class="p">(</span><span class="n">customerLock</span><span class="p">,</span> <span class="n">customer</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="kt">Pg</span><span class="o">.</span><span class="n">locked_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
     <span class="n">guard_</span> <span class="p">(</span><span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">customer</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;London&quot;</span><span class="p">)</span>
     <span class="n">employee</span> <span class="ow">&lt;-</span> <span class="n">filter_</span> <span class="p">(</span><span class="nf">\</span><span class="n">e</span> <span class="ow">-&gt;</span> <span class="n">fromMaybe_</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">employeeAddress</span> <span class="n">e</span><span class="p">))</span> <span class="o">==.</span> <span class="s">&quot;Paris&quot;</span> <span class="o">&amp;&amp;.</span>
                                <span class="n">just_</span> <span class="p">(</span><span class="n">pk</span> <span class="n">e</span><span class="p">)</span> <span class="o">==.</span> <span class="n">customerSupportRep</span> <span class="n">customer</span><span class="p">)</span> <span class="o">$</span>
                 <span class="n">all_</span> <span class="p">(</span><span class="n">employee</span> <span class="n">chinookDb</span><span class="p">)</span>
     <span class="n">pure</span> <span class="p">(</span><span class="kt">Pg</span><span class="o">.</span><span class="n">lockAll_</span> <span class="p">(</span><span class="n">customerFirstName</span> <span class="n">customer</span><span class="p">,</span> <span class="n">customerLastName</span> <span class="n">customer</span><span class="p">,</span> <span class="n">pk</span> <span class="n">employee</span><span class="p">))</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-6-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
       <span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;EmployeeId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">CROSS</span> <span class="k">JOIN</span> <span class="ss">&quot;Employee&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t1&quot;</span>
<span class="k">WHERE</span> <span class="p">((</span><span class="n">COALESCE</span><span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;London&#39;</span><span class="p">))</span>
  <span class="k">AND</span> <span class="p">(((</span><span class="n">COALESCE</span><span class="p">(</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Paris&#39;</span><span class="p">))</span>
       <span class="k">AND</span> <span class="p">((</span><span class="ss">&quot;t1&quot;</span><span class="p">.</span><span class="ss">&quot;EmployeeId&quot;</span><span class="p">)</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">DISTINCT</span>
            <span class="k">FROM</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;SupportRepId&quot;</span><span class="p">)))</span>
  <span class="k">FOR</span> <span class="k">SHARE</span> <span class="n">SKIP</span> <span class="n">LOCKED</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Table locks have the type <code>PgLockedTables s</code>, where <code>s</code> is the thread
parameter, as described
<a href="../../queries/basic/#the-q-data-type">here</a></p>
</div>
<h3 id="distinct-on-support"><code>DISTINCT ON</code> support</h3>
<p>Postgres supports the <code>DISTINCT ON</code> clause with selects to return distinct
results based on a particular key. The <code>beam-postgres</code> package provides the
<code>pgNubBy_</code> function to use this feature.</p>
<p>For example, to get an arbitrary customer from each distinct area code</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-7-Haskell" aria-controls="tab-7-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-7-Postgres" aria-controls="tab-7-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-7-Haskell">
            <div class="codehilite"><pre><span></span><span class="kt">Pg</span><span class="o">.</span><span class="n">pgNubBy_</span> <span class="p">(</span><span class="n">addressPostalCode</span> <span class="o">.</span> <span class="n">customerAddress</span><span class="p">)</span> <span class="o">$</span>
  <span class="n">all_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-7-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">ON</span> <span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span><span class="p">)</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;CustomerId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res2&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Company&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res3&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Address&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res4&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res5&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;State&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res6&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Country&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res7&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res8&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Phone&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res9&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Fax&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res10&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;Email&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res11&quot;</span><span class="p">,</span>
                   <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;SupportRepId&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res12&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<h3 id="aggregates">Aggregates</h3>
<h4 id="string_agg"><code>string_agg</code></h4>
<p>The Postgres <code>string_agg</code> aggregate combines all column values in a group
separated by a given separator. <code>beam-postgres</code> provides <code>pgStringAgg</code> and
<code>pgStringAggOver</code> to use the unquantified and quantified versions of the
<code>string_agg</code> aggregate appropriately.</p>
<p>For example, to put together a list of all cities in all the postal codes we have for customers,</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-8-Haskell" aria-controls="tab-8-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-8-Postgres" aria-controls="tab-8-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-8-Haskell">
            <div class="codehilite"><pre><span></span><span class="nf">aggregate_</span> <span class="p">(</span><span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> <span class="p">(</span> <span class="n">group_</span> <span class="p">(</span><span class="n">addressPostalCode</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">c</span><span class="p">))</span>
                  <span class="p">,</span> <span class="kt">Pg</span><span class="o">.</span><span class="n">pgStringAgg</span> <span class="p">(</span><span class="n">coalesce_</span> <span class="p">[</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">c</span><span class="p">)]</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="s">&quot;,&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="o">$</span>
  <span class="n">all_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-8-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="n">string_agg</span><span class="p">(</span><span class="n">COALESCE</span><span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>The above will include one city multiple times if its shared by multiple customers.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-9-Haskell" aria-controls="tab-9-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-9-Postgres" aria-controls="tab-9-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-9-Haskell">
            <div class="codehilite"><pre><span></span><span class="nf">aggregate_</span> <span class="p">(</span><span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> <span class="p">(</span> <span class="n">group_</span> <span class="p">(</span><span class="n">addressPostalCode</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">c</span><span class="p">))</span>
                  <span class="p">,</span> <span class="kt">Pg</span><span class="o">.</span><span class="n">pgStringAggOver</span> <span class="n">distinctInGroup_</span> <span class="p">(</span><span class="n">coalesce_</span> <span class="p">[</span><span class="n">addressCity</span> <span class="p">(</span><span class="n">customerAddress</span> <span class="n">c</span><span class="p">)]</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="s">&quot;,&quot;</span><span class="p">)</span> <span class="p">)</span> <span class="o">$</span>
  <span class="n">all_</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-9-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">SELECT</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span> <span class="k">AS</span> <span class="ss">&quot;res0&quot;</span><span class="p">,</span>
       <span class="n">string_agg</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">COALESCE</span><span class="p">(</span><span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="ss">&quot;res1&quot;</span>
<span class="k">FROM</span> <span class="ss">&quot;Customer&quot;</span> <span class="k">AS</span> <span class="ss">&quot;t0&quot;</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="ss">&quot;t0&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<h3 id="on-conflict">ON CONFLICT</h3>
<p>Beam supports <code>ON CONFLICT</code> statements in a Postgres-specific version of
<code>insert</code>. The code below uses the following imports to ensure the correct <code>insert</code> is used:</p>
<div class="codehilite"><pre><span></span><span class="kr">import</span> <span class="nn">Database.Beam</span> <span class="k">hiding</span> <span class="p">(</span><span class="nf">insert</span><span class="p">)</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Database.Beam.Postgres</span> <span class="k">as</span> <span class="n">Pg</span>
</pre></div>


<p>The 3rd argument of the <code>insert</code> from <code>Database.Beam.Postgres</code> allows
you to specify an <code>ON CONFLICT</code> clause. You can use
<code>onConflictDefault</code> in order to recover the standard behavior.</p>
<div class="codehilite"><pre><span></span><span class="nf">insert</span> <span class="ow">::</span> <span class="kt">DatabaseEntity</span> <span class="kt">Postgres</span> <span class="n">db</span> <span class="p">(</span><span class="kt">TableEntity</span> <span class="n">table</span><span class="p">)</span>
       <span class="ow">-&gt;</span> <span class="kt">SqlInsertValues</span> <span class="kt">PgInsertValuesSyntax</span> <span class="n">table</span>
       <span class="ow">-&gt;</span> <span class="kt">PgInsertOnConflict</span> <span class="n">table</span>
       <span class="ow">-&gt;</span> <span class="kt">SqlInsert</span> <span class="kt">PgInsertSyntax</span>
</pre></div>


<p>An explicit <code>ON CONFLICT</code> statement requires to specify the indexes
which are conflicting and an action to take when a conflict is
discovered. The <code>onConflict</code> function allows you to specify these
parts of the <code>ON CONFLICT</code> clause.</p>
<div class="codehilite"><pre><span></span><span class="nf">onConflict</span> <span class="ow">::</span> <span class="kt">Beamable</span> <span class="n">tbl</span>
           <span class="ow">=&gt;</span> <span class="kt">PgInsertOnConflictTarget</span> <span class="n">tbl</span>
           <span class="ow">-&gt;</span> <span class="kt">PgConflictAction</span> <span class="n">tbl</span>
           <span class="ow">-&gt;</span> <span class="kt">PgInsertOnConflict</span> <span class="n">tbl</span>
</pre></div>


<h4 id="acting-on-any-conflict">Acting on any conflict</h4>
<p>The <code>anyConflict</code> value causes the action to be executed when any
index or constraint is violated by the specified <code>INSERT</code>. The
following example causes any conflicting update to be ignored. This
could be useful if you want to upsert rows into a database.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-10-Haskell" aria-controls="tab-10-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-10-Postgres" aria-controls="tab-10-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-10-Haskell">
            <div class="codehilite"><pre><span></span><span class="c1">-- import qualified Database.Beam.Postgres as Pg</span>
<span class="kr">let</span>
  <span class="n">newCustomer</span> <span class="ow">=</span> <span class="kt">Customer</span> <span class="mi">42</span> <span class="s">&quot;John&quot;</span> <span class="s">&quot;Doe&quot;</span> <span class="kt">Nothing</span> <span class="p">(</span><span class="kt">Address</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;Street&quot;</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;City&quot;</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;State&quot;</span><span class="p">)</span> <span class="kt">Nothing</span> <span class="kt">Nothing</span><span class="p">)</span> <span class="kt">Nothing</span> <span class="kt">Nothing</span> <span class="s">&quot;john.doe@johndoe.com&quot;</span> <span class="n">nothing_</span>

<span class="nf">runInsert</span> <span class="o">$</span>
  <span class="kt">Pg</span><span class="o">.</span><span class="n">insert</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="n">insertValues</span> <span class="p">[</span><span class="n">newCustomer</span><span class="p">])</span> <span class="o">$</span>
    <span class="kt">Pg</span><span class="o">.</span><span class="n">onConflict</span>
      <span class="kt">Pg</span><span class="o">.</span><span class="n">anyConflict</span>
      <span class="kt">Pg</span><span class="o">.</span><span class="n">onConflictDoNothing</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-10-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">&quot;Customer&quot;</span><span class="p">(</span><span class="ss">&quot;CustomerId&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;FirstName&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;LastName&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Company&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Address&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;City&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;State&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Country&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;PostalCode&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Phone&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Fax&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Email&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;SupportRepId&quot;</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">42</span><span class="p">,</span>
        <span class="s1">&#39;John&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Doe&#39;</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="s1">&#39;Street&#39;</span><span class="p">,</span>
        <span class="s1">&#39;City&#39;</span><span class="p">,</span>
        <span class="s1">&#39;State&#39;</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="s1">&#39;john.doe@johndoe.com&#39;</span><span class="p">,</span>
        <span class="k">null</span><span class="p">)</span> <span class="k">ON</span> <span class="n">CONFLICT</span> <span class="k">DO</span> <span class="k">NOTHING</span><span class="p">;</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<h4 id="acting-only-on-certain-conflicts">Acting only on certain conflicts</h4>
<p>Sometimes you only want to perform an action if a certain constraint
is violated.  If the conflicting index or constraint is on a field,
you can specify the fields with the function <code>conflictingFields</code>.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-11-Haskell" aria-controls="tab-11-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-11-Postgres" aria-controls="tab-11-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-11-Haskell">
            <div class="codehilite"><pre><span></span><span class="c1">-- import qualified Database.Beam.Postgres as Pg</span>
<span class="kr">let</span>
  <span class="n">newCustomer</span> <span class="ow">=</span> <span class="kt">Customer</span> <span class="mi">42</span> <span class="s">&quot;John&quot;</span> <span class="s">&quot;Doe&quot;</span> <span class="kt">Nothing</span> <span class="p">(</span><span class="kt">Address</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;Street&quot;</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;City&quot;</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;State&quot;</span><span class="p">)</span> <span class="kt">Nothing</span> <span class="kt">Nothing</span><span class="p">)</span> <span class="kt">Nothing</span> <span class="kt">Nothing</span> <span class="s">&quot;john.doe@johndoe.com&quot;</span> <span class="n">nothing_</span>

<span class="nf">runInsert</span> <span class="o">$</span>
  <span class="kt">Pg</span><span class="o">.</span><span class="n">insert</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="n">insertValues</span> <span class="p">[</span><span class="n">newCustomer</span><span class="p">])</span> <span class="o">$</span>
    <span class="kt">Pg</span><span class="o">.</span><span class="n">onConflict</span>
      <span class="p">(</span><span class="kt">Pg</span><span class="o">.</span><span class="n">conflictingFields</span> <span class="n">primaryKey</span><span class="p">)</span>
      <span class="kt">Pg</span><span class="o">.</span><span class="n">onConflictSetAll</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-11-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">&quot;Customer&quot;</span><span class="p">(</span><span class="ss">&quot;CustomerId&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;FirstName&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;LastName&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Company&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Address&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;City&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;State&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Country&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;PostalCode&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Phone&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Fax&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Email&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;SupportRepId&quot;</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">42</span><span class="p">,</span>
        <span class="s1">&#39;John&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Doe&#39;</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="s1">&#39;Street&#39;</span><span class="p">,</span>
        <span class="s1">&#39;City&#39;</span><span class="p">,</span>
        <span class="s1">&#39;State&#39;</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="s1">&#39;john.doe@johndoe.com&#39;</span><span class="p">,</span>
        <span class="k">null</span><span class="p">)</span> <span class="k">ON</span> <span class="n">CONFLICT</span> <span class="p">(</span><span class="ss">&quot;CustomerId&quot;</span><span class="p">)</span> <span class="k">DO</span>
<span class="k">UPDATE</span>
<span class="k">SET</span> <span class="ss">&quot;CustomerId&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;CustomerId&quot;</span><span class="p">),</span>
    <span class="ss">&quot;FirstName&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span><span class="p">),</span>
    <span class="ss">&quot;LastName&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span><span class="p">),</span>
    <span class="ss">&quot;Company&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;Company&quot;</span><span class="p">),</span>
    <span class="ss">&quot;Address&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;Address&quot;</span><span class="p">),</span>
    <span class="ss">&quot;City&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">),</span>
    <span class="ss">&quot;State&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;State&quot;</span><span class="p">),</span>
    <span class="ss">&quot;Country&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;Country&quot;</span><span class="p">),</span>
    <span class="ss">&quot;PostalCode&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span><span class="p">),</span>
    <span class="ss">&quot;Phone&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;Phone&quot;</span><span class="p">),</span>
    <span class="ss">&quot;Fax&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;Fax&quot;</span><span class="p">),</span>
    <span class="ss">&quot;Email&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;Email&quot;</span><span class="p">),</span>
    <span class="ss">&quot;SupportRepId&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;SupportRepId&quot;</span><span class="p">);</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>To specify a conflict on the primary keys, use <code>conflictingField primaryKey</code>.</p>
</div>
<p>If the conflict target is an index, use <code>conflictingConstraint</code>, and supply the name of the constraint</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-12-Haskell" aria-controls="tab-12-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-12-Postgres" aria-controls="tab-12-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-12-Haskell">
            <div class="codehilite"><pre><span></span><span class="c1">-- import qualified Database.Beam.Postgres as Pg</span>
<span class="kr">let</span>
  <span class="n">newCustomer</span> <span class="ow">=</span> <span class="kt">Customer</span> <span class="mi">42</span> <span class="s">&quot;John&quot;</span> <span class="s">&quot;Doe&quot;</span> <span class="kt">Nothing</span> <span class="p">(</span><span class="kt">Address</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;Street&quot;</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;City&quot;</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;State&quot;</span><span class="p">)</span> <span class="kt">Nothing</span> <span class="kt">Nothing</span><span class="p">)</span> <span class="kt">Nothing</span> <span class="kt">Nothing</span> <span class="s">&quot;john.doe@johndoe.com&quot;</span> <span class="n">nothing_</span>

<span class="nf">runInsert</span> <span class="o">$</span>
  <span class="kt">Pg</span><span class="o">.</span><span class="n">insert</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="n">insertValues</span> <span class="p">[</span><span class="n">newCustomer</span><span class="p">])</span> <span class="o">$</span>
    <span class="kt">Pg</span><span class="o">.</span><span class="n">onConflict</span>
      <span class="p">(</span><span class="kt">Pg</span><span class="o">.</span><span class="n">conflictingConstraint</span> <span class="s">&quot;PK_Customer&quot;</span><span class="p">)</span>
      <span class="kt">Pg</span><span class="o">.</span><span class="n">onConflictSetAll</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-12-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">&quot;Customer&quot;</span><span class="p">(</span><span class="ss">&quot;CustomerId&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;FirstName&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;LastName&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Company&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Address&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;City&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;State&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Country&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;PostalCode&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Phone&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Fax&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Email&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;SupportRepId&quot;</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">42</span><span class="p">,</span>
        <span class="s1">&#39;John&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Doe&#39;</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="s1">&#39;Street&#39;</span><span class="p">,</span>
        <span class="s1">&#39;City&#39;</span><span class="p">,</span>
        <span class="s1">&#39;State&#39;</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="s1">&#39;john.doe@johndoe.com&#39;</span><span class="p">,</span>
        <span class="k">null</span><span class="p">)</span> <span class="k">ON</span> <span class="n">CONFLICT</span> <span class="k">ON</span> <span class="k">CONSTRAINT</span> <span class="ss">&quot;PK_Customer&quot;</span> <span class="k">DO</span>
<span class="k">UPDATE</span>
<span class="k">SET</span> <span class="ss">&quot;CustomerId&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;CustomerId&quot;</span><span class="p">),</span>
    <span class="ss">&quot;FirstName&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span><span class="p">),</span>
    <span class="ss">&quot;LastName&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span><span class="p">),</span>
    <span class="ss">&quot;Company&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;Company&quot;</span><span class="p">),</span>
    <span class="ss">&quot;Address&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;Address&quot;</span><span class="p">),</span>
    <span class="ss">&quot;City&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;City&quot;</span><span class="p">),</span>
    <span class="ss">&quot;State&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;State&quot;</span><span class="p">),</span>
    <span class="ss">&quot;Country&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;Country&quot;</span><span class="p">),</span>
    <span class="ss">&quot;PostalCode&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;PostalCode&quot;</span><span class="p">),</span>
    <span class="ss">&quot;Phone&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;Phone&quot;</span><span class="p">),</span>
    <span class="ss">&quot;Fax&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;Fax&quot;</span><span class="p">),</span>
    <span class="ss">&quot;Email&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;Email&quot;</span><span class="p">),</span>
    <span class="ss">&quot;SupportRepId&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;SupportRepId&quot;</span><span class="p">);</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<h4 id="specifying-actions">Specifying actions</h4>
<p>Often times, you do not want to update every field on a conflict. For
example, for upserts, you rarely want to update the primary key. The
function <code>onConflictUpdateInstead</code> allows you to restrict which fields
are updated in the case of a conflict. The required function argument
is a projection of which fields ought to be updated.</p>
<p>In the example below, we insert a new row, but if a row with the given
primary key already exists, we update <em>only</em> the first and last name.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-13-Haskell" aria-controls="tab-13-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-13-Postgres" aria-controls="tab-13-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-13-Haskell">
            <div class="codehilite"><pre><span></span><span class="c1">-- import qualified Database.Beam.Postgres as Pg</span>
<span class="kr">let</span>
  <span class="n">newCustomer</span> <span class="ow">=</span> <span class="kt">Customer</span> <span class="mi">42</span> <span class="s">&quot;John&quot;</span> <span class="s">&quot;Doe&quot;</span> <span class="kt">Nothing</span> <span class="p">(</span><span class="kt">Address</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;Street&quot;</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;City&quot;</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;State&quot;</span><span class="p">)</span> <span class="kt">Nothing</span> <span class="kt">Nothing</span><span class="p">)</span> <span class="kt">Nothing</span> <span class="kt">Nothing</span> <span class="s">&quot;john.doe@johndoe.com&quot;</span> <span class="n">nothing_</span>

<span class="nf">runInsert</span> <span class="o">$</span>
  <span class="kt">Pg</span><span class="o">.</span><span class="n">insert</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="n">insertValues</span> <span class="p">[</span><span class="n">newCustomer</span><span class="p">])</span> <span class="o">$</span>
    <span class="kt">Pg</span><span class="o">.</span><span class="n">onConflict</span>
      <span class="p">(</span><span class="kt">Pg</span><span class="o">.</span><span class="n">conflictingFields</span> <span class="n">primaryKey</span><span class="p">)</span>
      <span class="p">(</span><span class="kt">Pg</span><span class="o">.</span><span class="n">onConflictUpdateInstead</span>
         <span class="p">(</span><span class="nf">\</span><span class="n">c</span> <span class="ow">-&gt;</span> <span class="p">(</span> <span class="n">customerFirstName</span> <span class="n">c</span>
                <span class="p">,</span> <span class="n">customerLastName</span> <span class="n">c</span> <span class="p">)))</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-13-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">&quot;Customer&quot;</span><span class="p">(</span><span class="ss">&quot;CustomerId&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;FirstName&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;LastName&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Company&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Address&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;City&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;State&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Country&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;PostalCode&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Phone&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Fax&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Email&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;SupportRepId&quot;</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">42</span><span class="p">,</span>
        <span class="s1">&#39;John&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Doe&#39;</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="s1">&#39;Street&#39;</span><span class="p">,</span>
        <span class="s1">&#39;City&#39;</span><span class="p">,</span>
        <span class="s1">&#39;State&#39;</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="s1">&#39;john.doe@johndoe.com&#39;</span><span class="p">,</span>
        <span class="k">null</span><span class="p">)</span> <span class="k">ON</span> <span class="n">CONFLICT</span> <span class="p">(</span><span class="ss">&quot;CustomerId&quot;</span><span class="p">)</span> <span class="k">DO</span>
<span class="k">UPDATE</span>
<span class="k">SET</span> <span class="ss">&quot;FirstName&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span><span class="p">),</span>
    <span class="ss">&quot;LastName&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span><span class="p">);</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
<p>You can also specify a more specific update, using the
<code>onConflictUpdateSet</code> function. This is the most general form of the
postgres <code>ON CONFLICT</code> action. The <code>excluded</code> table is provided as the
second argument. The syntax of the updates is similar to that of
<code>update</code>.</p>
<p>In the following example, we append the old first name to the new
first name and replace the old last name.</p>
<p>
                <div class="code-nav-container">
                    
        <ul class="nav nav-tabs">
            
        <li class="nav-item">
            <a href="#tab-33-Haskell" aria-controls="tab-33-Haskell" role="tab" data-toggle="tab" data-lang="haskell">Haskell</a>
        </li>
    
        <li class="nav-item">
            <a href="#tab-33-Postgres" aria-controls="tab-33-Postgres" role="tab" data-toggle="tab" data-lang="sql">Postgres</a>
        </li>
    
        </ul>
    
        <div class="tab-content">
            
        <div role="tabpanel" class="tab-pane active" id="tab-33-Haskell">
            <div class="codehilite"><pre><span></span><span class="c1">-- import qualified Database.Beam.Postgres as Pg</span>
<span class="kr">let</span>
  <span class="n">newCustomer</span> <span class="ow">=</span> <span class="kt">Customer</span> <span class="mi">42</span> <span class="s">&quot;John&quot;</span> <span class="s">&quot;Doe&quot;</span> <span class="kt">Nothing</span> <span class="p">(</span><span class="kt">Address</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;Street&quot;</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;City&quot;</span><span class="p">)</span> <span class="p">(</span><span class="kt">Just</span> <span class="s">&quot;State&quot;</span><span class="p">)</span> <span class="kt">Nothing</span> <span class="kt">Nothing</span><span class="p">)</span> <span class="kt">Nothing</span> <span class="kt">Nothing</span> <span class="s">&quot;john.doe@johndoe.com&quot;</span> <span class="n">nothing_</span>

<span class="nf">runInsert</span> <span class="o">$</span>
  <span class="kt">Pg</span><span class="o">.</span><span class="n">insert</span> <span class="p">(</span><span class="n">customer</span> <span class="n">chinookDb</span><span class="p">)</span> <span class="p">(</span><span class="n">insertValues</span> <span class="p">[</span><span class="n">newCustomer</span><span class="p">])</span> <span class="o">$</span>
    <span class="kt">Pg</span><span class="o">.</span><span class="n">onConflict</span>
      <span class="p">(</span><span class="kt">Pg</span><span class="o">.</span><span class="n">conflictingFields</span> <span class="n">primaryKey</span><span class="p">)</span>
      <span class="p">(</span><span class="kt">Pg</span><span class="o">.</span><span class="n">onConflictUpdateSet</span>
        <span class="c1">-- tbl is the old row, tblExcluded is the row proposed for insertion</span>
        <span class="p">(</span><span class="nf">\</span><span class="n">tbl</span> <span class="n">tblExcluded</span> <span class="ow">-&gt;</span>
          <span class="p">[</span> <span class="p">(</span><span class="n">customerFirstName</span> <span class="n">tbl</span><span class="p">)</span> <span class="o">&lt;-.</span> <span class="n">concat_</span> <span class="p">[</span> <span class="n">current_</span> <span class="p">(</span><span class="n">customerFirstName</span> <span class="n">tbl</span><span class="p">),</span>  <span class="n">customerFirstName</span> <span class="n">tblExcluded</span> <span class="p">]</span>
          <span class="p">,</span> <span class="p">(</span><span class="n">customerLastName</span> <span class="n">tbl</span><span class="p">)</span> <span class="o">&lt;-.</span> <span class="p">(</span><span class="n">customerLastName</span> <span class="n">tblExcluded</span><span class="p">)</span> <span class="p">]</span>
        <span class="p">)</span>
      <span class="p">)</span>
</pre></div>

        </div>
    
        <div role="tabpanel" class="tab-pane " id="tab-33-Postgres">
            <div class="codehilite"><pre><span></span><span class="k">INSERT</span> <span class="k">INTO</span> <span class="ss">&quot;Customer&quot;</span><span class="p">(</span><span class="ss">&quot;CustomerId&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;FirstName&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;LastName&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Company&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Address&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;City&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;State&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Country&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;PostalCode&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Phone&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Fax&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;Email&quot;</span><span class="p">,</span>
                       <span class="ss">&quot;SupportRepId&quot;</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">42</span><span class="p">,</span>
        <span class="s1">&#39;John&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Doe&#39;</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="s1">&#39;Street&#39;</span><span class="p">,</span>
        <span class="s1">&#39;City&#39;</span><span class="p">,</span>
        <span class="s1">&#39;State&#39;</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="k">null</span><span class="p">,</span>
        <span class="s1">&#39;john.doe@johndoe.com&#39;</span><span class="p">,</span>
        <span class="k">null</span><span class="p">)</span> <span class="k">ON</span> <span class="n">CONFLICT</span> <span class="p">(</span><span class="ss">&quot;CustomerId&quot;</span><span class="p">)</span> <span class="k">DO</span>
<span class="k">UPDATE</span>
<span class="k">SET</span> <span class="ss">&quot;FirstName&quot;</span><span class="o">=</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="ss">&quot;Customer&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span><span class="p">,</span> <span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;FirstName&quot;</span><span class="p">)),</span>
    <span class="ss">&quot;LastName&quot;</span><span class="o">=</span><span class="p">(</span><span class="ss">&quot;excluded&quot;</span><span class="p">.</span><span class="ss">&quot;LastName&quot;</span><span class="p">);</span>
</pre></div>

        </div>
    
        </div>
    
                </div>
                    </p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../../schema-guide/supported/" title="Supported migrations" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Supported migrations
              </span>
            </div>
          </a>
        
        
          <a href="../beam-sqlite/" title="beam-sqlite" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                beam-sqlite
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    

      <script src="../../../assets/javascripts/application-6b599127bc.js"></script>
      <script>app.initialize({url:{base:"../../.."}})</script>
      
    
<script type="text/javascript" language="javascript"  src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script type="text/javascript" language="javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript" language="javascript">
 $(document.body).tab();
 $(".nav-item:first-child").tab("show");
</script>

    
      
    
  </body>
</html>